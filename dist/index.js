class S extends Error{response;request;options;constructor(t,e,a){const o=t.status||t.status===0?t.status:"",r=t.statusText||"",i=`${o} ${r}`.trim(),n=i?`status code ${i}`:"an unknown error";super(`Request failed with ${n}: ${e.method} ${e.url}`),this.name="HTTPError",this.response=t,this.request=e,this.options=a}}class C extends Error{request;constructor(t){super(`Request timed out: ${t.method} ${t.url}`),this.name="TimeoutError",this.request=t}}const y=s=>s!==null&&typeof s=="object",g=(...s)=>{for(const t of s)if((!y(t)||Array.isArray(t))&&t!==void 0)throw new TypeError("The `options` argument must be an object");return v({},...s)},$=(s={},t={})=>{const e=new globalThis.Headers(s),a=t instanceof globalThis.Headers,o=new globalThis.Headers(t);for(const[r,i]of o.entries())a&&i==="undefined"||i===void 0?e.delete(r):e.set(r,i);return e};function b(s,t,e){return Object.hasOwn(t,e)&&t[e]===void 0?[]:v(s[e]??[],t[e]??[])}const j=(s={},t={})=>({beforeRequest:b(s,t,"beforeRequest"),beforeRetry:b(s,t,"beforeRetry"),afterResponse:b(s,t,"afterResponse"),beforeError:b(s,t,"beforeError")}),v=(...s)=>{let t={},e={},a={};for(const o of s)if(Array.isArray(o))Array.isArray(t)||(t=[]),t=[...t,...o];else if(y(o)){for(let[r,i]of Object.entries(o))y(i)&&r in t&&(i=v(t[r],i)),t={...t,[r]:i};y(o.hooks)&&(a=j(a,o.hooks),t.hooks=a),y(o.headers)&&(e=$(e,o.headers),t.headers=e)}return t},B=(()=>{let s=!1,t=!1;const e=typeof globalThis.ReadableStream=="function",a=typeof globalThis.Request=="function";if(e&&a)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return s=!0,"half"}}).headers.has("Content-Type")}catch(o){if(o instanceof Error&&o.message==="unsupported BodyInit type")return!1;throw o}return s&&!t})(),z=typeof globalThis.AbortController=="function",J=typeof globalThis.ReadableStream=="function",G=typeof globalThis.FormData=="function",U=["get","post","put","patch","head","delete"],V={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},w=2147483647,E=Symbol("stop"),F={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},K={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},W=s=>U.includes(s)?s.toUpperCase():s,X=["get","put","head","delete","options","trace"],Y=[408,413,429,500,502,503,504],Q=[413,429,503],x={limit:2,methods:X,statusCodes:Y,afterStatusCodes:Q,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:s=>.3*2**(s-1)*1e3},Z=(s={})=>{if(typeof s=="number")return{...x,limit:s};if(s.methods&&!Array.isArray(s.methods))throw new Error("retry.methods must be an array");if(s.statusCodes&&!Array.isArray(s.statusCodes))throw new Error("retry.statusCodes must be an array");return{...x,...s}};async function tt(s,t,e,a){return new Promise((o,r)=>{const i=setTimeout(()=>{e&&e.abort(),r(new C(s))},a.timeout);a.fetch(s,t).then(o).catch(r).then(()=>{clearTimeout(i)})})}async function et(s,{signal:t}){return new Promise((e,a)=>{t&&(t.throwIfAborted(),t.addEventListener("abort",o,{once:!0}));function o(){clearTimeout(r),a(t.reason)}const r=setTimeout(()=>{t?.removeEventListener("abort",o),e()},s)})}const st=(s,t)=>{const e={};for(const a in t)!(a in K)&&!(a in F)&&!(a in s)&&(e[a]=t[a]);return e};class k{static create(t,e){const a=new k(t,e),o=async()=>{if(typeof a._options.timeout=="number"&&a._options.timeout>w)throw new RangeError(`The \`timeout\` option cannot be greater than ${w}`);await Promise.resolve();let n=await a._fetch();for(const l of a._options.hooks.afterResponse){const p=await l(a.request,a._options,a._decorateResponse(n.clone()));p instanceof globalThis.Response&&(n=p)}if(a._decorateResponse(n),!n.ok&&a._options.throwHttpErrors){let l=new S(n,a.request,a._options);for(const p of a._options.hooks.beforeError)l=await p(l);throw l}if(a._options.onDownloadProgress){if(typeof a._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!J)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return a._stream(n.clone(),a._options.onDownloadProgress)}return n},i=a._options.retry.methods.includes(a.request.method.toLowerCase())?a._retry(o):o();for(const[n,l]of Object.entries(V))i[n]=async()=>{a.request.headers.set("accept",a.request.headers.get("accept")||l);const p=await i;if(n==="json"){if(p.status===204||(await p.clone().arrayBuffer()).byteLength===0)return"";if(e.parseJson)return e.parseJson(await p.text())}return p[n]()};return i}request;abortController;_retryCount=0;_input;_options;constructor(t,e={}){if(this._input=t,this._options={...e,headers:$(this._input.headers,e.headers),hooks:j({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},e.hooks),method:W(e.method??this._input.method??"GET"),prefixUrl:String(e.prefixUrl||""),retry:Z(e.retry),throwHttpErrors:e.throwHttpErrors!==!1,timeout:e.timeout??1e4,fetch:e.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(z){this.abortController=new globalThis.AbortController;const a=this._options.signal??this._input.signal;a?.aborted&&this.abortController.abort(a?.reason),a?.addEventListener("abort",()=>{this.abortController.abort(a.reason)}),this._options.signal=this.abortController.signal}if(B&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const o="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),r=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,o);(G&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(r,{...this.request}),this._options)}}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof C)throw t;if(t instanceof S){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;const a=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(a&&this._options.retry.afterStatusCodes.includes(t.response.status)){let o=Number(a)*1e3;Number.isNaN(o)?o=Date.parse(a)-Date.now():o>=Date.parse("2024-01-01")&&(o-=Date.now());const r=this._options.retry.maxRetryAfter??o;return o<r?o:r}if(t.response.status===413)throw t}const e=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,e)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(e){const a=Math.min(this._calculateRetryDelay(e),w);if(this._retryCount<1)throw e;await et(a,{signal:this._options.signal});for(const o of this._options.hooks.beforeRetry)if(await o({request:this.request,options:this._options,error:e,retryCount:this._retryCount})===E)return;return this._retry(t)}}async _fetch(){for(const a of this._options.hooks.beforeRequest){const o=await a(this.request,this._options);if(o instanceof Request){this.request=o;break}if(o instanceof Response)return o}const t=st(this.request,this._options),e=this.request;return this.request=e.clone(),this._options.timeout===!1?this._options.fetch(e,t):tt(e,t,this.abortController,this._options)}_stream(t,e){const a=Number(t.headers.get("content-length"))||0;let o=0;return t.status===204?(e&&e({percent:1,totalBytes:a,transferredBytes:o},new Uint8Array),new globalThis.Response(null,{status:t.status,statusText:t.statusText,headers:t.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(r){const i=t.body.getReader();e&&e({percent:0,transferredBytes:0,totalBytes:a},new Uint8Array);async function n(){const{done:l,value:p}=await i.read();if(l){r.close();return}if(e){o+=p.byteLength;const h=a===0?0:o/a;e({percent:h,transferredBytes:o,totalBytes:a},p)}r.enqueue(p),await n()}await n()}}),{status:t.status,statusText:t.statusText,headers:t.headers})}}/*! MIT License Â© Sindre Sorhus */const I=s=>{const t=(e,a)=>k.create(e,g(s,a));for(const e of U)t[e]=(a,o)=>k.create(a,g(s,o,{method:e}));return t.create=e=>I(g(e)),t.extend=e=>(typeof e=="function"&&(e=e(s??{})),I(g(s,e))),t.stop=E,t},L=I(),at="https://accounts.spotify.com/api/token",d="https://api.spotify.com/v1",ot=()=>localStorage.getItem("clientId")||"",A=s=>{application.postUiMessage(s)},q=(s,t)=>{localStorage.setItem("access_token",s),t&&localStorage.setItem("refresh_token",t)},c=L.create({hooks:{beforeRequest:[s=>{s.headers.set("Authorization",`Bearer ${localStorage.getItem("access_token")}`)}],afterResponse:[async(s,t,e)=>{if(e.status===401){const a=await O();return s.headers.set("Authorization",`Bearer ${a}`),c(s,t)}}]}}),O=async()=>{const s=localStorage.getItem("refresh_token");if(s)try{const t=new URLSearchParams;t.append("grant_type","refresh_token"),t.append("refresh_token",s),t.append("client_id",ot());const e=await L.post(at,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t}).json();if(e.access_token&&e.refresh_token)return q(e.access_token,e.refresh_token),e.access_token}catch{return localStorage.getItem("access_token")}};function _(s){return s.map(t=>({albumApiId:"album"in t?t.album.uri:void 0,apiId:t.uri,artistApiId:t.artists[0].uri,artistName:t.artists[0].name,addtionalArtists:t.artists.slice(1).map(e=>({name:e.name,apiId:e.uri})),duration:t.duration_ms/1e3,images:"album"in t?t.album.images:[],name:t.name}))}function P(s){return s.map(t=>({apiId:t.uri,name:t.name,images:t.images}))}function R(s){return s.map(t=>({apiId:t.uri,artistName:t.artists[0].name,artistApiId:t.artists[0].id,addtionalArtists:t.artists.slice(1).map(e=>({name:e.name,apiId:e.id})),name:t.name,images:t.images}))}class rt{constructor(){this.name="spotify",this.previousState=null,this.initializePlayer=()=>{const t=new window.Spotify.Player({getOAuthToken:async e=>{const a=await O();a&&e(a)},name:"AudioGata Player"});t.addListener("initialization_error",e=>{console.error(e)}),t.addListener("authentication_error",e=>{console.error(e)}),t.addListener("account_error",e=>{console.error(e)}),t.addListener("playback_error",e=>{console.error(e)}),t.addListener("player_state_changed",async e=>{e?(this.interval=setInterval(async()=>{let a=await t.getCurrentState();a&&await application.setTrackTime(a.position/1e3)},1e3),e&&this.previousState&&!this.previousState.paused&&e.paused&&e.position===0&&(this.previousState=e,this.interval&&clearInterval(this.interval),setTimeout(application.endTrack,100)),this.previousState=e):this.interval&&clearInterval(this.interval)}),t.addListener("ready",({device_id:e})=>{console.log("Ready with Device ID",e),this.deviceId=e,this.resolveReady(void 0)}),t.addListener("not_ready",({device_id:e})=>{console.log("Device ID has gone offline",e)}),t.connect()},this.deviceId="",window.onSpotifyWebPlaybackSDKReady=this.initializePlayer.bind(this),this.readyPromise=new Promise(t=>{this.resolveReady=t})}loadScript(){const t=document.createElement("script");t.id="spotify-player",t.type="text/javascript",t.async=!1,t.defer=!0,t.src="https://sdk.scdn.co/spotify-player.js",document.head.appendChild(t)}async play(t){const e=new Promise((r,i)=>{setTimeout(()=>i(),5e3)});if(await Promise.race([this.readyPromise,e]),!this.deviceId)return;const a=`${d}/me/player/play?device_id=${this.deviceId}`,o=t.apiId||"";await c.put(a,{json:{uris:[o],position_ms:(t.seekTime??0)*1e3},headers:{"Content-Type":"application/json"}})}async pause(){this.deviceId&&this.previousState&&!this.previousState.paused&&await c.put("https://api.spotify.com/v1/me/player/pause",{headers:{"Content-Type":"application/json"}})}async resume(){this.deviceId&&await c.put(`https://api.spotify.com/v1/me/player/play?device_id=${this.deviceId}`,{headers:{"Content-Type":"application/json"}})}async seek(t){this.deviceId&&await c.put(`https://api.spotify.com/v1/me/player/seek?position_ms=${t*1e3}&device_id=${this.deviceId}`,{headers:{"Content-Type":"application/json"}})}async setVolume(t){await c.put(`https://api.spotify.com/v1/me/player/volume?volume_percent=${Math.round(t*100)}`,{headers:{"Content-Type":"application/json"}})}}async function it(s){const t=`${d}/search?q=${encodeURIComponent(s.query)}&type=album,artist,track`,e=await c.get(t).json(),a=_(e.tracks?.items||[]),o=R(e.albums?.items||[]),r=P(e.artists?.items||[]);return{tracks:{items:a,pageInfo:e.tracks&&{resultsPerPage:e.tracks.limit,totalResults:e.tracks.total,offset:e.tracks.offset,nextPage:e.tracks.next||void 0,prevPage:e.tracks.previous||void 0}},albums:{items:o,pageInfo:e.albums&&{resultsPerPage:e.albums.limit,totalResults:e.albums.total,offset:e.albums.offset,nextPage:e.albums.next||void 0,prevPage:e.albums.previous||void 0}},artists:{items:r,pageInfo:e.artists&&{resultsPerPage:e.artists.limit,totalResults:e.artists.total,offset:e.artists.offset,nextPage:e.artists.next||void 0,prevPage:e.artists.previous||void 0}}}}async function nt(s){let t=`${d}/search?q=${encodeURIComponent(s.query)}&type=track`;s.pageInfo?.nextPage?t=s.pageInfo.nextPage:s.pageInfo?.prevPage&&(t=s.pageInfo.prevPage);const e=await c.get(t).json();return{items:_(e.tracks?.items||[]),pageInfo:e.tracks&&{resultsPerPage:e.tracks.limit,totalResults:e.tracks.total,offset:e.tracks.offset,nextPage:e.tracks.next||void 0,prevPage:e.tracks.previous||void 0}}}async function ct(s){let t=`${d}/search?q=${encodeURIComponent(s.query)}&type=album`;s.pageInfo?.nextPage?t=s.pageInfo.nextPage:s.pageInfo?.prevPage&&(t=s.pageInfo.prevPage);const e=await c.get(t).json();return{items:R(e.albums?.items||[]),pageInfo:e.albums&&{resultsPerPage:e.albums.limit,totalResults:e.albums.total,offset:e.albums.offset,nextPage:e.albums.next||void 0,prevPage:e.albums.previous||void 0}}}async function lt(s){let t=`${d}/search?q=${encodeURIComponent(s.query)}&type=track`;s.pageInfo?.nextPage?t=s.pageInfo.nextPage:s.pageInfo?.prevPage&&(t=s.pageInfo.prevPage);const e=await c.get(t).json();return{items:P(e.artists?.items||[]),pageInfo:e.artists&&{resultsPerPage:e.artists.limit,totalResults:e.artists.total,offset:e.artists.offset,nextPage:e.artists.next||void 0,prevPage:e.artists.previous||void 0}}}async function pt(s){const t=s.apiId?.split(":").pop(),e=`${d}/albums/${t}`,a=await c.get(e).json(),o=_(a.tracks.items);return o.forEach(r=>{r.albumApiId=s.apiId,r.images=a.images}),{album:{name:a.name,artistName:a.artists[0].name,artistApiId:a.artists[0].id,addtionalArtists:a.artists.slice(1).map(r=>({name:r.name,apiId:r.id})),apiId:a.id,images:a.images},items:o}}async function ut(s){const t=s.apiId?.split(":").pop(),e=`${d}/artists/${t}`;let a=`${d}/artists/${t}/albums`;s.pageInfo?.nextPage?a=s.pageInfo.nextPage:s.pageInfo?.prevPage&&(a=s.pageInfo.prevPage);const o=await c.get(e).json(),r=await c.get(a).json();return{items:R(r.items),pageInfo:{resultsPerPage:r.limit,totalResults:r.total,offset:r.offset,nextPage:r.next||void 0,prevPage:r.previous||void 0},artist:{name:o.name,apiId:o.id,images:o.images}}}async function M(s){const t=`https://api.spotify.com/v1/playlists/${s.apiId}`,e=await c.get(t).json(),a={name:e.name,images:e.images.map(h=>({width:h.width||0,height:h.height||0,url:h.url})),apiId:e.id},o=50;let r=0,i=`${t}/tracks?limit=${o}`;s.pageInfo?.nextPage?i=s.pageInfo.nextPage:s.pageInfo?.prevPage&&(i=s.pageInfo.prevPage);let n=[],l=!0;for(;l;){const h=await c.get(`${i}&offset=${r}`).json(),T=h.items.map(f=>({albumApiId:f.track?.album&&f.track.album.uri,apiId:f.track?.uri,artistName:f.track?.artists[0].name,artistApiId:f.track?.artists[0].uri,addtionalArtists:f.track?.artists.slice(1).map(m=>({name:m.name,apiId:m.uri})),duration:(f.track?.duration_ms||0)/1e3,images:f.track?.album.images.map(m=>({url:m.url,height:m.height||0,width:m.width||0}))||[],name:f.track?.name||""}));n=n.concat(T),r+=o,h.next||(l=!1)}return{playlist:a,items:n}}async function ht(s){let t="https://api.spotify.com/v1/me/playlists";s.pageInfo?.nextPage?t=s.pageInfo.nextPage:s.pageInfo?.prevPage&&(t=s.pageInfo.prevPage);const e=await c.get(t).json();return{items:e.items.map(r=>({name:r.name,images:r.images.map(i=>({width:i.width||0,height:i.height||0,url:i.url})),apiId:r.id})),pageInfo:{resultsPerPage:e.limit,offset:e.offset,totalResults:e.total,nextPage:e.next||void 0,prevPage:e.previous||void 0}}}async function ft(){const s="https://api.spotify.com/v1/me/top/tracks",t="https://api.spotify.com/v1/me/top/artists",e=c.get(s).json(),a=c.get(t).json(),o=await Promise.all([e,a]);return{tracks:{items:_(o[0].items)},artists:{items:P(o[1].items)}}}const N=/https?:\/\/(?:play|open)\.spotify\.[^\/]+\/(playlist)\/([^\/\?]+)/;async function dt(s){const t=s.match(N);if(t){const e=t[2],a=await M({apiId:e});return{...a.playlist,tracks:a.items}}throw new Error("Can't retreive playlist")}const u=new rt,D=()=>{application.onSearchAll=it,application.onGetAlbumTracks=pt,application.onGetArtistAlbums=ut,application.onGetPlaylistTracks=M,application.onSearchTracks=nt,application.onSearchArtists=lt,application.onSearchAlbums=ct,application.onGetUserPlaylists=ht,application.onGetTopItems=ft,application.onCanParseUrl=async(s,t)=>{switch(t){case"playlist":return N.test(s);default:return!1}},application.onLookupPlaylistUrl=dt,application.onPlay=u.play.bind(u),application.onPause=u.pause.bind(u),application.onResume=u.resume.bind(u),application.onSeek=u.seek.bind(u),application.onSetVolume=u.setVolume.bind(u),u.loadScript()},mt=async()=>{const s=localStorage.getItem("access_token"),t=localStorage.getItem("refresh_token");s&&t&&D();const e=await application.getTheme();H(e)};application.onDeepLinkMessage=async s=>{application.postUiMessage({type:"deeplink",url:s})};const yt=async s=>{switch(s.type){case"logout":localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token");break;case"set-keys":localStorage.setItem("clientId",s.clientId);break;case"check-login":const t=localStorage.getItem("access_token"),e=localStorage.getItem("refresh_token");t&&e&&A({type:"login"});const o=document.location.host.split(".");o.shift();const r=await application.getPluginId(),i=o.join("."),n=`${document.location.protocol}//${i}`,l=localStorage.getItem("clientId")??"";A({type:"info",origin:n,pluginId:r,clientId:l});break;case"login":q(s.accessToken,s.refreshToken),D();break}};application.onUiMessage=yt;const H=s=>{localStorage.setItem("kb-color-mode",s)};application.onChangeTheme=async s=>{H(s)};mt();
